#include "phaser.h"
#include "helper.h"

//float coeff10k[16] = { -0.037367988377809525, -0.016523672267794609, -0.048529494553804398, \
                        -0.040865261107683182, -0.090225353837013245, -0.102609783411026, \ 
                        -0.22072523832321167, -0.61925923824310303,  0.61925923824310303, \
                        0.22072523832321167,  0.102609783411026,  0.090225353837013245, \
                        0.040865261107683182,  0.048529494553804398,  0.016523672267794609, \
                        0.037367988377809525};

float coeff10k[127] = {
  -0.005946901269245121,
  -0.003221105934752321,
  -0.0038440699902768365,
  -0.00433518589331418,
  -0.00461808266722396,
  -0.004610544806595846,
  -0.004229573289430788,
  -0.0033917453968697465,
  -0.0020280510416206474,
  -0.00007797378693000696,
  0.0024926916286312235,
  0.00569982765877049,
  0.009534812572960348,
  0.013961833701309627,
  0.018917781140524174,
  0.024309521855601125,
  0.030016610101736976,
  0.03589781173597167,
  0.04180040186066688,
  0.047555344979786536,
  0.052984157628638756,
  0.05792015092713824,
  0.06221396733171681,
  0.06570516590449127,
  0.06829411291109369,
  0.069881349050518,
  0.07041715978547827,
  0.069881349050518,
  0.06829411291109369,
  0.06570516590449127,
  0.062213967331716816,
  0.05792015092713824,
  0.052984157628638756,
  0.047555344979786536,
  0.04180040186066688,
  0.03589781173597167,
  0.030016610101736976,
  0.024309521855601125,
  0.018917781140524174,
  0.013961833701309627,
  0.009534812572960348,
  0.00569982765877049,
  0.0024926916286312235,
  -0.00007797378693000696,
  -0.0020280510416206474,
  -0.0033917453968697465,
  -0.004229573289430788,
  -0.004610544806595846,
  -0.00461808266722396,
  -0.004335185893314184,
  -0.0038440699902768365,
  -0.003221105934752321,
  -0.005946901269245121
};

void Phaser(volatile float* pData, void *opaque){
    struct Phaser_t *tmp = (struct Phaser_t*)opaque;
    uint32_t i;

    arm_fir_instance_f32 S;
    arm_status status;
    float32_t firStateF32[SAMPLE_NUM + 53 - 1];
    float32_t firOutput[SAMPLE_NUM];
    
    arm_fir_init_f32(&S, 53, (float32_t *)&coeff10k[0], &firStateF32[0], SAMPLE_NUM);

    arm_fir_f32(&S, pData , firOutput, SAMPLE_NUM);
/*
    for(i = 0; i < SAMPLE_NUM; i++){
        *pData = *firOutput;
    } */
    //Combine(pData, firOutput);
    return;
}

void delete_Phaser(void *opaque){
    return;
}

void adjust_Phaser(void *opaque, uint8_t* values){
    return;
}

struct Effect_t* new_Phaser(struct Phaser_t* opaque){
    strcpy(opaque->parent.name, "Phaser");
    opaque->parent.func = Phaser;
    opaque->parent.del = delete_Phaser;
    opaque->parent.adj = adjust_Phaser;

    return (struct Effect_t*)opaque;
}

